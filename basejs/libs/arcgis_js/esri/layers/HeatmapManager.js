// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.13/esri/copyright.txt for details.
define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/_base/array","require","../kernel","../sniff","../geometry/Point","../geometry/webMercatorUtils","./MapImage","../renderers/HeatmapRenderer","../tasks/query","dojo/_base/fx"],function(e,t,r,a,n,i,s,o,h,c,u,l,d){function m(){}function g(e){var t=e.geometry,r=e.attributes,a=e.layer;return{geometry:t,attributes:r,getLayer:function(){return a}}}var p=e(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(e){this.sourceLayer=e,this._hndls=[]},initialize:function(e){this.map=e;var r=this.sourceLayer,a=r.renderer;r.setDrawMode(!1),this.imageLayer=e._getMapImageLyr();var i=this;this.heatmapRenderer=a instanceof u?a:(a.getRendererInfoByZoom(e.getZoom())||a.getRendererInfoByScale(e.getScale())).renderer,this.recalculateHeatmap=this.recalculateHeatmap.bind(this),this._removeRenderer=this._removeRenderer.bind(this),this._handleRendererChange=this._handleRendererChange.bind(this),this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange),this._handleOpacityChange=this._handleOpacityChange.bind(this),this._reprojectFeature=this._reprojectFeature.bind(this),n(["../workers/heatmapCalculator"],function(e){i._calculator=new e(t.mixin({width:i.map.width,height:i.map.height},i._getOptions())),i._setupRenderer(),i.heatmapRenderer.getStats=e.calculateStats,i.heatmapRenderer.getHistogramData=e.getHistogramData})},destroy:function(){this._removeHandlers(),this._rendererChangeHandle&&this._rendererChangeHandle.remove(),this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(e){var t=e.renderer,r=t instanceof u;this.heatmapRenderer?r?this.heatmapRenderer=t:this._removeRenderer(e):r&&(this.heatmapRenderer=t,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(e){var t=e.opacity,r=this._getImageBySourceId(this.sourceLayer.id);r&&r.setOpacity(t)},_setupRenderer:function(){var e=this._hndls,t=this.sourceLayer,n=this.map,i=this;t._originalDraw=t._draw,t._draw=m,t._div.clear(),setTimeout(this._resetGraphics.bind(this),250),e.push(t.on("update-end",function(){i.recalculateHeatmap()})),e.push(t.on("suspend",function(){var e=i._getImageBySourceId(i.sourceLayer.id);e&&e.hide()})),e.push(t.on("resume",function(){var e=i._getImageBySourceId(i.sourceLayer.id);e&&e.show()})),e.push(r.after(t,"redraw",this.recalculateHeatmap)),e.push(n.on("layer-remove",function(e){if(e.layer==t){var r=i._getImageBySourceId(i.sourceLayer.id);r&&i.imageLayer.removeImage(r),i._removeRenderer({target:t})}})),t._collection&&e.push(t.on("graphic-add",function(e){i._reprojectFeature(e.graphic)})),1!==t.mode&&(e.push(n.on("resize, pan-end",function(){setTimeout(i.recalculateHeatmap,16)})),e.push(n.on("zoom-end",function(){setTimeout(function(){t._getRenderer().isInstanceOf(u)&&i.recalculateHeatmap()},16)}))),e.push(t.on("opacity-change",this._handleOpacityChange)),this.imageLayer.suspended&&this.imageLayer.resume(),t.graphics&&t.graphics.length&&(t.graphics[0].geometry&&!n.spatialReference.equals(t.graphics[0].geometry.spatialReference)&&a.forEach(t.graphics,function(e){this._reprojectFeature(e)}.bind(this)),this.recalculateHeatmap())},_removeRenderer:function(e){var t=e.target;t._draw=t._originalDraw,delete t._originalDraw,t.setDrawMode(!0),this._removeHandlers(),this._hndls=[];var r=this._getImageBySourceId(this.sourceLayer.id);r&&this.imageLayer.removeImage(r),t.renderer!=e.renderer&&t.renderer.getRendererInfo?this.heatmapRenderer=null:(t.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(e){if(e&&e.geometry){var t=e.geometry,r=this.map.spatialReference,a=t.spatialReference;if(!r.equals(a)){var n=h.project(t,r);null==n?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):e.geometry=n}}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var e=this.sourceLayer,r=this.map,a=this.heatmapRenderer,n=this.map.extent,i=this.map.width,s=this.map.height,o=this._calculator,h=this,u=function(u){var l=h._getScreenPoints(u.features,r,e),d=o.calculateImageData(t.mixin({screenPoints:l,mapinfo:{extent:[n.xmin,n.ymin,n.xmax,n.ymax],resolution:r.getResolution()},width:i,height:s},h._getOptions())),m=a.getSymbol(g({geometry:r.extent,attributes:{size:[i,s],imageData:d},layer:e})),p=new c({extent:r.extent,href:m.url,opacity:0,sourceId:e.id});h._swapMapImages(p,h._getImageBySourceId(e.id)),e.suspended&&p.hide()},d={geometry:r.extent,timeExtent:e.useMapTime?r.timeExtent:void 0,spatialRelationship:l.SPATIAL_REL_INTERSECTS};null!=e._canDoClientSideQuery(d)?e.queryFeatures(d,u):u({features:e.graphics})},_getScreenPoints:function(e,t,r){var n,i,s,h=[],c=e.length,u=0,l=0,d=new o(t.extent.xmin,t.extent.ymax,t.spatialReference),m=t.toScreen(d),g=m.x,p=m.y,y=t.getResolution(),_=t.extent.getCacheValue("_parts");for(_&&(s=a.map(_,function(e){return r._intersects(t,e.extent)[0]}));c--;)n=e[c],n.geometry&&(i={x:Math.ceil((n.geometry.x-d.x)/y+g),y:Math.floor((d.y-n.geometry.y)/y-p),attributes:n.attributes},s&&(l=s.length>1&&i.x<-s[0]?s[1]:s[0],i.x+=l),h[u++]=i);return h},_getImageBySourceId:function(e){var t=this.imageLayer.getImages();return t=a.filter(t,function(t){return t.sourceId==e}),t.length?t[t.length-1]:void 0},_swapMapImages:function(e,t){function r(){a.removeImage(t)}var a=this.imageLayer,n=this.sourceLayer,i=n.opacity||1;a.addImage(e),d.anim(e._node,{opacity:i},null,null,function(){e.opacity=i}),null!=t&&d.anim(t._node,{opacity:0},null,null,r)},_removeHandlers:function(){if(null!=this._hndls)for(var e=this._hndls.length;e--;)this._hndls[e].remove()},_getOptions:function(){var e=this.heatmapRenderer;return{blurRadius:e.blurRadius,gradient:e.gradient,maxPixelIntensity:e.maxPixelIntensity,minPixelIntensity:e.minPixelIntensity,field:e.field,fieldOffset:e.fieldOffset}},_resetGraphics:function(){for(var e,t=this.sourceLayer.graphics,r=t.length;r--;)e=t[r],e._shape=e._offsets=void 0}});return s("extend-esri")&&t.setObject("layers.HeatmapManager",p,i),p});